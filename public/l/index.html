<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ØªÙˆÙØ§Ù† ØªÙˆÛŒÛŒØªØ±ÛŒ - Redirecting...</title>
  <meta name="robots" content="noindex">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #15202b;
      color: #e7e9ea;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .container {
      max-width: 400px;
      width: 100%;
      text-align: center;
    }
    .logo {
      font-size: 48px;
      margin-bottom: 24px;
    }
    h1 {
      font-size: 24px;
      margin-bottom: 16px;
    }
    .loading {
      margin: 32px 0;
    }
    .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid #38444d;
      border-top-color: #1d9bf0;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .status {
      color: #8b98a5;
      font-size: 14px;
      margin-top: 12px;
    }
    .error {
      background: rgba(244, 33, 46, 0.1);
      border: 1px solid #f4212e;
      color: #f4212e;
      padding: 20px;
      border-radius: 12px;
      margin: 24px 0;
    }
    .hidden {
      display: none;
    }
    .manual-link {
      margin-top: 24px;
    }
    .btn {
      display: inline-block;
      padding: 14px 28px;
      border-radius: 9999px;
      font-size: 16px;
      font-weight: bold;
      text-decoration: none;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
      background: #1d9bf0;
      color: white;
    }
    .btn:hover {
      background: #1a8cd8;
    }
    .back-link {
      color: #1d9bf0;
      text-decoration: none;
      display: inline-block;
      margin-top: 32px;
      font-size: 14px;
    }
    .device-badge {
      display: inline-block;
      background: #38444d;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      margin-top: 8px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo">ğŸŒŠ</div>
    <h1>ØªÙˆÙØ§Ù† ØªÙˆÛŒÛŒØªØ±ÛŒ</h1>

    <div id="loading" class="loading">
      <div class="spinner"></div>
      <p>Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†ØªÙ‚Ø§Ù„...</p>
      <p id="status" class="status"></p>
      <span id="device-badge" class="device-badge"></span>
    </div>

    <div id="error" class="error hidden">
      <p>Ù„ÛŒÙ†Ú© ÛŒØ§ÙØª Ù†Ø´Ø¯ ÛŒØ§ Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>
    </div>

    <div id="manual" class="manual-link hidden">
      <p style="margin-bottom: 16px; color: #8b98a5;">Ø§Ú¯Ø± Ø¨Ù‡ ØµÙˆØ±Øª Ø®ÙˆØ¯Ú©Ø§Ø± Ù…Ù†ØªÙ‚Ù„ Ù†Ø´Ø¯ÛŒØ¯:</p>
      <a id="manual-btn" href="#" class="btn" target="_blank">Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ù„ÛŒÙ†Ú©</a>
    </div>

    <a href="/" class="back-link">â† Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ</a>
  </div>

  <script>
    // Get short code from URL path
    const pathParts = window.location.pathname.split('/');
    const shortCode = pathParts[pathParts.length - 1] || pathParts[pathParts.length - 2];

    // Detect device
    const userAgent = navigator.userAgent || navigator.vendor || window.opera;
    const isIOS = /iPad|iPhone|iPod/.test(userAgent) && !window.MSStream;
    const isAndroid = /android/i.test(userAgent);
    const isMobile = isIOS || isAndroid;

    // Show device info
    const deviceBadge = document.getElementById('device-badge');
    if (isIOS) {
      deviceBadge.textContent = 'ğŸ“± iOS';
    } else if (isAndroid) {
      deviceBadge.textContent = 'ğŸ¤– Android';
    } else {
      deviceBadge.textContent = 'ğŸ’» Desktop';
    }

    function updateStatus(text) {
      document.getElementById('status').textContent = text;
    }

    function showError() {
      document.getElementById('loading').classList.add('hidden');
      document.getElementById('error').classList.remove('hidden');
    }

    function showManualLink(url) {
      document.getElementById('manual').classList.remove('hidden');
      document.getElementById('manual-btn').href = url;
    }

    async function loadAndRedirect() {
      if (!shortCode || shortCode === 'l' || shortCode === 'index.html') {
        showError();
        return;
      }

      try {
        updateStatus('Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª...');

        const res = await fetch(`/api/deeplink?code=${shortCode}`);
        if (!res.ok) throw new Error('Not found');

        const data = await res.json();
        const deepLinks = data.deep_links;

        updateStatus('Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø² Ú©Ø±Ø¯Ù†...');

        // Show manual link as fallback (use web fallback URL)
        showManualLink(deepLinks.fallback);

        // Determine redirect URL based on device
        if (isIOS) {
          // iOS: Try to open Twitter/X app first
          window.location.href = deepLinks.ios;

          // Fallback to web after delay
          setTimeout(() => {
            window.location.href = deepLinks.fallback;
          }, 1500);

        } else if (isAndroid) {
          // Android: Use the native app URL with fallback
          const fallbackEncoded = encodeURIComponent(deepLinks.fallback);
          const intentUri = `intent://post#Intent;scheme=twitter;package=com.twitter.android;S.browser_fallback_url=${fallbackEncoded};end`;

          window.location.href = intentUri;

          // Fallback to web after delay
          setTimeout(() => {
            window.location.href = deepLinks.fallback;
          }, 1500);

        } else {
          // Desktop: Direct redirect to web intent
          window.location.href = deepLinks.fallback;
        }

      } catch (error) {
        console.error('Error:', error);
        showError();
      }
    }

    // Start redirect process
    loadAndRedirect();
  </script>
</body>
</html>
