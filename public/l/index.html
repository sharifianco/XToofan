<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ØªÙˆÙØ§Ù† ØªÙˆÛŒÛŒØªØ±ÛŒ - Deep Link</title>
  <meta name="robots" content="noindex">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #15202b;
      color: #e7e9ea;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .container {
      max-width: 500px;
      width: 100%;
      text-align: center;
    }
    .logo {
      font-size: 32px;
      margin-bottom: 24px;
    }
    h1 {
      font-size: 24px;
      margin-bottom: 16px;
    }
    .loading {
      margin: 32px 0;
    }
    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid #38444d;
      border-top-color: #1d9bf0;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .tweet-preview {
      background: #192734;
      border: 1px solid #38444d;
      border-radius: 16px;
      padding: 20px;
      margin: 24px 0;
      text-align: right;
    }
    .tweet-text {
      line-height: 1.6;
      margin-bottom: 16px;
      word-wrap: break-word;
    }
    .buttons {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 24px;
    }
    .btn {
      display: block;
      padding: 16px 24px;
      border-radius: 9999px;
      font-size: 16px;
      font-weight: bold;
      text-decoration: none;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
    }
    .btn-twitter {
      background: #1d9bf0;
      color: white;
    }
    .btn-twitter:hover {
      background: #1a8cd8;
    }
    .btn-instagram {
      background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%);
      color: white;
    }
    .btn-instagram:hover {
      opacity: 0.9;
    }
    .btn-copy {
      background: #38444d;
      color: white;
    }
    .btn-copy:hover {
      background: #4a5568;
    }
    .error {
      background: rgba(244, 33, 46, 0.1);
      border: 1px solid #f4212e;
      color: #f4212e;
      padding: 16px;
      border-radius: 8px;
      margin: 24px 0;
    }
    .hidden {
      display: none;
    }
    .device-info {
      font-size: 13px;
      color: #8b98a5;
      margin-top: 16px;
    }
    .back-link {
      color: #1d9bf0;
      text-decoration: none;
      display: inline-block;
      margin-top: 24px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo">ğŸŒŠ</div>
    <h1>ØªÙˆÙØ§Ù† ØªÙˆÛŒÛŒØªØ±ÛŒ</h1>

    <div id="loading" class="loading">
      <div class="spinner"></div>
      <p>Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</p>
    </div>

    <div id="content" class="hidden">
      <div id="tweet-preview" class="tweet-preview">
        <p id="tweet-text" class="tweet-text"></p>
      </div>

      <div class="buttons">
        <a id="btn-twitter" href="#" class="btn btn-twitter" target="_blank">
          ğŸ“± Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ø¯Ø± X (Twitter)
        </a>
        <button id="btn-instagram" class="btn btn-instagram">
          ğŸ“¸ Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ø¯Ø± Instagram Story
        </button>
        <button id="btn-copy" class="btn btn-copy">
          ğŸ“‹ Ú©Ù¾ÛŒ Ù„ÛŒÙ†Ú©
        </button>
      </div>

      <p id="device-info" class="device-info"></p>
    </div>

    <div id="error" class="error hidden">
      <p>Ù„ÛŒÙ†Ú© ÛŒØ§ÙØª Ù†Ø´Ø¯ ÛŒØ§ Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>
    </div>

    <a href="/" class="back-link">â† Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ</a>
  </div>

  <script>
    // Get short code from URL
    const pathParts = window.location.pathname.split('/');
    const shortCode = pathParts[pathParts.length - 1] || pathParts[pathParts.length - 2];

    // Detect device
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
    const isAndroid = /Android/.test(navigator.userAgent);
    const isMobile = isIOS || isAndroid;

    let linkData = null;

    async function loadLink() {
      if (shortCode && shortCode !== 'l' && shortCode !== 'index.html') {
        try {
          const res = await fetch(`/api/deeplink?code=${shortCode}`);
          if (!res.ok) throw new Error('Not found');

          linkData = await res.json();
          showContent();
        } catch (error) {
          showError();
        }
      } else {
        showError();
      }
    }

    function showContent() {
      document.getElementById('loading').classList.add('hidden');
      document.getElementById('content').classList.remove('hidden');

      // Show tweet text
      if (linkData.tweet_text) {
        document.getElementById('tweet-text').textContent = linkData.tweet_text;
      } else {
        document.getElementById('tweet-preview').classList.add('hidden');
      }

      // Set Twitter button
      const twitterBtn = document.getElementById('btn-twitter');
      twitterBtn.href = linkData.intent_url;

      // Set device info
      let deviceText = 'Ø¯Ø³ØªÚ¯Ø§Ù‡: ';
      if (isIOS) deviceText += 'iOS';
      else if (isAndroid) deviceText += 'Android';
      else deviceText += 'Desktop';
      document.getElementById('device-info').textContent = deviceText;

      // Instagram button
      document.getElementById('btn-instagram').addEventListener('click', openInstagram);

      // Copy button
      document.getElementById('btn-copy').addEventListener('click', copyLink);
    }

    function showError() {
      document.getElementById('loading').classList.add('hidden');
      document.getElementById('error').classList.remove('hidden');
    }

    function openInstagram() {
      if (!linkData) return;

      const deepLinks = linkData.deep_links;

      if (isIOS) {
        window.location.href = deepLinks.ios.instagram_story;
        // Fallback after timeout
        setTimeout(() => {
          window.location.href = linkData.intent_url;
        }, 2000);
      } else if (isAndroid) {
        window.location.href = deepLinks.android.instagram_story;
        setTimeout(() => {
          window.location.href = linkData.intent_url;
        }, 2000);
      } else {
        // Desktop - copy link instead
        copyDeepLinks();
      }
    }

    async function copyLink() {
      if (linkData) {
        try {
          await navigator.clipboard.writeText(linkData.intent_url);
          alert('Ù„ÛŒÙ†Ú© Ú©Ù¾ÛŒ Ø´Ø¯!');
        } catch (err) {
          // Fallback
          const textarea = document.createElement('textarea');
          textarea.value = linkData.intent_url;
          document.body.appendChild(textarea);
          textarea.select();
          document.execCommand('copy');
          document.body.removeChild(textarea);
          alert('Ù„ÛŒÙ†Ú© Ú©Ù¾ÛŒ Ø´Ø¯!');
        }
      }
    }

    async function copyDeepLinks() {
      if (!linkData) return;

      const text = `ğŸ”— Deep Links:

ğŸ“± iOS Instagram Story:
${linkData.deep_links.ios.instagram_story}

ğŸ¤– Android Instagram Story:
${linkData.deep_links.android.instagram_story}

ğŸ¦ Twitter/X:
${linkData.intent_url}`;

      try {
        await navigator.clipboard.writeText(text);
        alert('Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§ Ú©Ù¾ÛŒ Ø´Ø¯Ù†Ø¯!');
      } catch (err) {
        const textarea = document.createElement('textarea');
        textarea.value = text;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        alert('Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§ Ú©Ù¾ÛŒ Ø´Ø¯Ù†Ø¯!');
      }
    }

    // Load on page ready
    loadLink();
  </script>
</body>
</html>
